import { ReactNode } from "react";

import type { NextPage } from "next";
import Head from "next/head";

import {
  Box,
  Card,
  CardActionArea,
  CardContent,
  Stack,
  Typography,
} from "../components/Material";

import Link from "../components/Link";

import DateFormatter from "../utilities/date-formatter.utility";
import { instanceofReactElement } from "../utilities/types-helper.utility";

import type { PostFindAllResponse } from "../services/wordpress/post.service";
import useHtmlParser from "../hooks/useHtmlParser";

interface HomeProps {
  posts: PostFindAllResponse;
}

function getTextContent(components: ReactNode[]): string[] {
  return components
    .flatMap((child) => {
      if (typeof child === "string") {
        return child;
      } else if (instanceofReactElement(child)) {
        return getTextContent(child.props?.children ?? []);
      }
    })
    .filter<string>((child): child is string => typeof child === "string");
}

const Home: NextPage<HomeProps> = ({ posts }) => {
  const htmlParse = useHtmlParser();

  return (
    <>
      <Head>
        <title>Sebastian Gonzalez Quintero</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <Stack spacing={2}>
        {posts.data?.map((post) => (
          <Card key={post.id} variant="outlined">
            <CardActionArea component={Link} href={`/blog/${post.slug}`}>
              <CardContent>
                <Typography variant="subtitle2">
                  {DateFormatter(post.date)}
                </Typography>
                <Typography variant="h3">{post.title.rendered}</Typography>
                {/* <Box
                  sx={{ typography: "body2" }}
                  dangerouslySetInnerHTML={{ __html: post.excerpt.rendered }}
                /> */}
                <Typography variant="body2">
                  {getTextContent(htmlParse(post.excerpt?.rendered ?? ""))}
                </Typography>
              </CardContent>
            </CardActionArea>
          </Card>
        ))}
      </Stack>
    </>
  );
};

export default Home;

export async function getStaticProps() {
  const { default: PostService } = await import(
    "../services/wordpress/post.service"
  );

  let posts: PostFindAllResponse;
  try {
    posts = await PostService.findAll();
  } catch (err) {
    posts = {
      page: 0,
      total: 0,
    };
  }

  return {
    props: { posts },
    revalidate: 10,
  };
}
